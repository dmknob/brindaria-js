<%- include('../layouts/layout-top') %>

<div class="max-w-3xl mx-auto py-8">
    
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">
            <%= peca ? 'Editar Peça / Venda' : 'Registrar Nova Peça' %>
        </h2>
        <a href="/admin/pecas" class="text-sm text-gray-500 hover:text-gray-800">← Cancelar</a>
    </div>

    <form action="/admin/pecas/<%= peca ? peca.id + '/editar' : 'nova' %>" method="POST" class="bg-white p-8 rounded shadow space-y-6 border border-gray-200">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6 border-b border-gray-100">
            
            <div class="col-span-2 md:col-span-1">
                <label class="block text-gray-700 font-bold mb-2">Modelo *</label>
                <select name="modelo_id" id="modeloSelect" required class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-amber-500 bg-white">
                    <option value="" disabled <%= !peca ? 'selected' : '' %>>Selecione...</option>
                    <% modelos.forEach(m => { %>
                        <option value="<%= m.id %>" <%= (peca && peca.modelo_id === m.id) ? 'selected' : '' %>>
                            <%= m.nome %>
                        </option>
                    <% }) %>
                </select>
            </div>

            <div>
                <label class="block text-gray-700 font-bold mb-2">Código Exibição (#) *</label>
                <input type="text" name="codigo_exibicao" id="codExibicao" required 
                       value="<%= peca ? peca.codigo_exibicao : '' %>"
                       class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-amber-500 font-mono font-bold text-amber-600 bg-gray-50">
                <% if (!peca) { %>
                    <p class="text-xs text-gray-400 mt-1">Será gerado automaticamente ao escolher o modelo.</p>
                <% } %>
                <input type="hidden" name="codigo_sequencial" value="0"> 
            </div>

            <div>
                <label class="block text-gray-700 font-bold mb-2">Tamanho</label>
                <input type="text" name="tamanho" value="<%= peca ? peca.tamanho : '20cm' %>" 
                       class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-amber-500">
            </div>

            <div class="col-span-2 md:col-span-1">
                <label class="block text-gray-700 font-bold mb-2">Inscrição na Base (Destaque)</label>
                <input type="text" name="inscricao_base" value="<%= peca ? peca.inscricao_base : '' %>" 
                       placeholder="Ex: Protegei a Alicia" maxlength="40"
                       class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-amber-500 font-bold text-gray-800">
                <p class="text-xs text-gray-400 mt-1">O texto curto gravado na frente da peça.</p>
            </div>

            <div>
                <label class="block text-gray-700 font-bold mb-2">Material</label>
                <input type="text" name="material" value="<%= peca ? peca.material : 'Compósito Ecológico' %>" class="w-full p-3 border border-gray-300 rounded">
            </div>
            <div>
                <label class="block text-gray-700 font-bold mb-2">Acabamento</label>
                <input type="text" name="acabamento" value="<%= peca ? peca.acabamento : 'Visual Mármore' %>" class="w-full p-3 border border-gray-300 rounded">
            </div>

            <div>
                <label class="block text-gray-700 font-bold mb-2">Data de Produção</label>
                <input type="month" name="data_producao" required
                       value="<%= peca ? peca.data_producao : '' %>" 
                       placeholder="AAAA-MM"
                       class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-amber-500 bg-white">
                
                <p class="text-xs text-gray-500 mt-1">
                    Selecione no calendário ou digite: <strong>Ano-Mês</strong> (ex: 2025-11).
                </p>
            </div>

        </div>

        <div>
            <h3 class="text-lg font-bold text-gray-800 mb-4">Dados do Presente</h3>
            
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Nome do Cliente (Comprador)</label>
                <input type="text" name="cliente_nome" value="<%= peca ? peca.cliente_nome : '' %>" 
                       placeholder="Ex: Pedro Knob" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-amber-500">
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Dedicatória Completa</label>
                <textarea name="mensagem" rows="4" 
                          class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-amber-500 font-serif italic"
                          placeholder="Peça oferecida por X para Y..."><%= peca ? peca.mensagem : '' %></textarea>
            </div>
        </div>

        <div class="pt-4 flex flex-col gap-4">
            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded shadow-lg text-lg transition">
                <%= peca ? 'Salvar Alterações' : 'Registrar Peça' %> </button>
        </div>
    </form>

    <% if (peca) { %>
        <div class="mt-12 pt-6 border-t border-gray-200 text-center">
            <h4 class="text-sm font-bold text-gray-500 mb-2">Zona de Perigo</h4>
            <form action="/admin/pecas/<%= peca.id %>/delete" method="POST" onsubmit="return confirm('ATENÇÃO: Tem certeza que deseja excluir o registro desta peça? Isso apagará o código #<%= peca.codigo_exibicao %> permanentemente.');">
                <button type="submit" class="text-red-500 hover:text-red-700 underline text-sm">
                    Excluir esta peça permanentemente
                </button>
            </form>
        </div>
    <% } %>

</div>

<% if (!peca) { %>
<script>
    const select = document.getElementById('modeloSelect');
    const inputExibicao = document.getElementById('codExibicao');

    select.addEventListener('change', async (e) => {
        const id = e.target.value;
        if(!id) return;
        
        // Simulação simples de contagem no client-side para não precisar de API
        // Nota: Idealmente seria via API, mas removemos a API.
        // Vamos deixar o usuário preencher ou implementar um helper simples de sugestão visual
        // Como removemos a API, o campo fica livre. 
        // Sugestão visual:
        inputExibicao.placeholder = "Carregando...";
        
        // Se quiser reativar a sugestão automática, precisaria daquela rota de API.
        // Como removemos, deixe o campo livre ou coloque um valor padrão.
        // inputExibicao.value = "#..."; 
    });
</script>
<% } %>

<%- include('../layouts/layout-bottom') %>